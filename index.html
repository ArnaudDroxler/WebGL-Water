<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>WebGL Water</title>
            <link rel="stylesheet" href="./css/stylesheet.css">
            <script type="text/javascript" src="./js/gl-matrix.js"></script>
            <script type="text/javascript" src="./js/webgl-debug.js"></script>
            <script type="text/javascript" src="./js/webgl-utils.js"></script>
            <script type="text/javascript" src="./js/shader.js"></script>
            <script type="text/javascript" src="./js/camera.js"></script>
            <script type="text/javascript" src="js/grid.js"></script>
            <script type="text/javascript" src="js/skybox.js"></script>
            <script type="text/javascript" src="./js/water.js"></script>
            <script id="skybox-shader-vs"  type="x-shader/x-vertex">
             uniform mat4 view;
             uniform mat4 projection;
             attribute vec3 aPos;
             varying vec3 texCoord;
             void main() {
                texCoord = aPos;
                vec4 pos = projection * view * vec4(aPos, 1.0);
                gl_Position = pos.xyww;

             }
            </script>
            <script id="skybox-shader-fs"  type="x-shader/x-fragment">
             precision mediump float;
             varying vec3 texCoord;
             uniform samplerCube skybox;
             void main() {
                  gl_FragColor = textureCube(skybox, texCoord);
             }
            </script>
            <script id="shader-vs" type="x-shader/x-vertex">

            attribute vec3 aPosition;
            //attribute vec3 aNormal;
            attribute vec2 aTexture;

            varying vec3 normals;
            varying vec3 fragPos;
            varying vec2 textureCoord;

            uniform mat4 model;
            uniform mat4 view;
            uniform mat4 projection;
            uniform mat3 normal;
            uniform float detalX;

            void main(){
                fragPos = vec3(model * vec4(aPosition, 1.0));
                //fragPos.y = sin(fragPos.x * 0.6 + float(detalX) * 0.2);
                //normals = normal * aNormal;
                textureCoord = aTexture;
                gl_Position = projection * view * vec4(fragPos, 1.0);
            }
            </script>
            <script id="shader-fs" type="x-shader/x-fragment">
            precision highp float;
            struct Light {
                vec3 position;
                vec3 ambient;
                vec3 diffuse;
                vec3 specular;
            };
            varying vec3 fragPos;
            //varying vec3 normals;
            varying vec2 textureCoord;

            uniform vec3 viewPos;
            uniform Light light;

            uniform sampler2D normalSampler;
            uniform samplerCube skybox;
            uniform float detalX;

            void main() {


             // ambient

            float density = 0.005;

            const float LOG2 = 1.442695;
            float z = gl_FragCoord.z / gl_FragCoord.w;
            float fogFactor = exp2( -density * density *  z *  z * LOG2 );
            fogFactor = clamp(fogFactor, 0.0, 1.0);


            vec3 ambient = light.ambient * vec3(0.2,0.2,2.0);

            // diffuse
            vec4 normalTex1 = texture2D(normalSampler, vec2(textureCoord.s + detalX/2048.0, textureCoord.t - detalX/2048.0));
            //vec4 normalTex2 = texture2D(normalSampler, vec2(textureCoord.t + detalX/2048.0, textureCoord.s - detalX/2048.0));
            vec3 norm = normalize(normalTex1.xyz);
            vec3 lightDir = normalize(light.position - fragPos);
            float diff = max(dot(norm, lightDir), 0.0);
            vec3 diffuse = light.diffuse * diff * vec3(0.3,0.5,1.0);

            // specular
            vec3 viewDir = normalize(viewPos - fragPos);
            vec3 reflectDir = reflect(-lightDir, norm);
            float spec = pow(max(dot(viewDir, reflectDir), 0.0), 1024.0);
            vec3 specular = light.specular * (spec * vec3(0.2,0.2,0.2));

            vec3 result = ambient + diffuse + specular;


            vec3 I = normalize(fragPos - viewPos);
            vec3 R = reflect(I, norm);
            vec3 reflection = textureCube(skybox, R).rgb;

            float ratio = 1.00 / 1.33;
            vec3 Ir = normalize(fragPos - viewPos);
            vec3 Rr = refract(Ir, norm , ratio);
            vec3 refraction  = textureCube(skybox, Rr).rgb;



            //vec3 finalcolor = mix(vec3(0.3,0.5,1.0), reflection, fogFactor );

            gl_FragColor = vec4(reflection,1.0);
            }
            </script>
    </head>
<body>
<div id="container">
    <div id="canvas">
        <canvas id="glcanvas"></canvas>
    </div>
</div>
</body>
</html>
